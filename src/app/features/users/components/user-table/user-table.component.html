<div class="table-container">
    @if (!store.loading() && !store.error() && store.users().length) {
      <div class="mb-3">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Search users..." 
            [ngModel]="searchQuery()"
            (ngModelChange)="onSearch($event)"
          >
        </div>
      </div>
    }

    @if (store.loading()) {
      <div class="loading-spinner">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    } 
    
    @if (store.error()) {
      <div class="alert alert-danger">
        {{ store.error() }}
      </div>
    }

    @if (!store.loading() && !store.error() && store.users().length) {
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              @for (header of tableHeaders(); track header) {
                <th>{{ header | titlecase }}</th>
              }
              <th class="actions-header">Actions</th>
            </tr>
          </thead>

          <tbody>
            @for (user of store.paginatedUsers(); track user.id) {
              <tr [class.editing]="isEditing(user.id)" 
                  (click)="handleRowClick(user.id)">
                @for (header of tableHeaders(); track header) {
                  <td>
                    <ng-container 
                      [ngTemplateOutlet]="isEditing(user.id) ? editTemplate : displayTemplate"
                      [ngTemplateOutletContext]="{ $implicit: user, header: header }">
                    </ng-container>
                  </td>
                }
                <td class="actions" (click)="$event.stopPropagation()">
                  <ng-container 
                    [ngTemplateOutlet]="isEditing(user.id) ? editActions : viewActions"
                    [ngTemplateOutletContext]="{ $implicit: user }">
                  </ng-container>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <nav aria-label="Page navigation" class="d-flex justify-content-center mt-3">
          <ul class="pagination">
            <li class="page-item" [class.disabled]="store.currentPage() === 1">
              <button class="page-link" (click)="store.setPage(store.currentPage() - 1)">
                Previous
              </button>
            </li>
            
            @for (page of store.pageNumbers(); track page) {
              <li class="page-item" [class.active]="page === store.currentPage()">
                <button class="page-link" (click)="store.setPage(page)">
                  {{ page }}
                </button>
              </li>
            }
            
            <li class="page-item" [class.disabled]="store.currentPage() === store.totalPages()">
              <button class="page-link" (click)="store.setPage(store.currentPage() + 1)">
                Next
              </button>
            </li>
          </ul>
        </nav>
      </div>
    }

    @if (!store.loading() && !store.error() && !store.paginatedUsers().length && store.users().length) {
      <div class="alert alert-info">
        No users found matching your search.
      </div>
    }
  </div>

  <ng-template #displayTemplate let-user let-header="header">
    <span class="cell-content">{{ user[header] }}</span>
  </ng-template>

  <ng-template #editTemplate let-user let-header="header">
    <app-editable-cell
      [value]="user[header]"
      (valueChange)="updateField(user, header, $event)"
      (click)="$event.stopPropagation()"
    />
  </ng-template>

  <ng-template #editActions let-user>
    <button class="btn btn-success btn-sm me-2" (click)="saveEdit()">
      <i class="bi bi-check-lg"></i> Save
    </button>
    <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">
      <i class="bi bi-x-lg"></i> Cancel
    </button>
  </ng-template>

  <ng-template #viewActions let-user>
    <button class="btn btn-primary btn-sm" (click)="startEdit(user.id)">
      <i class="bi bi-pencil"></i> Edit
    </button>
  </ng-template>